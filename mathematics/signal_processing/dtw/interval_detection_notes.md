# DTW による区間検出の概要

本資料では `interval_detection.py` に実装した動的時間伸縮法 (Dynamic Time Warping; DTW) を用いた、ゆっくりと周波数が変化する正弦波の周期ごとの区間推定アルゴリズムを解説します。

## 信号モデル

基準となるテンプレートは周波数 $f_0$ の正弦波で、サンプリング周波数 $f_s$ で離散化します。時間ベクトル $t$ に対しテンプレートは

$$x_{\text{template}}(t) = \sin(2\pi f_0 t)$$

で表されます。

観測信号は線形に周波数が変化すると仮定し、

$$f(t) = f_0\left(1 + \alpha \frac{t}{T}\right)$$

と定義します。ここで $T$ は観測時間、$\alpha$ は周波数がどの程度変化するかを決める係数です。瞬時周波数を積分すると位相が得られ、

$$\phi[n] = 2\pi \sum_{k=0}^{n} \frac{f(k / f_s)}{f_s}$$

となり、最終的な信号は $x[n] = \sin(\phi[n])$ です。

## DTW による整列

テンプレートと観測信号の離散サンプル $x_{\text{template}}[i]$, $x[j]$ を用い、要素ごとの距離行列

$$D_{i,j} = \lvert x_{\text{template}}[i] - x[j] \rvert$$

を作成します。これをもとに DTW の累積コスト行列を

$$C_{i,j} = D_{i,j} + \min\{C_{i-1,j},\, C_{i,j-1},\, C_{i-1,j-1}\}$$

で更新し、終端 $(i=j=N-1)$ から逆走査することでテンプレートと信号のインデックスを結ぶ最適ワーピング経路 $\mathcal{P} = \{(i_k, j_k)\}$ を取得します。

## テンプレート周期の信号時間への写像

各テンプレートインデックス $i$ について、経路に出現する信号インデックス $j$ を平均して滑らかな写像 $m(i)$ を得ます。経路に現れない点は線形補間で埋めて、単調増加な写像を保証します。

テンプレートの周期境界は

$$t_k = \frac{k}{f_0}$$

で表され、対応する信号サンプルは $m(t_k f_s)$ により推定できます。これを $f_s$ で割ることで推定周期開始時刻 $\hat{\tau}_k$ を得ます。

## 区間と周波数の推定

周期長は

$$\Delta_k = \hat{\tau}_{k+1} - \hat{\tau}_k$$

で計算し、DTW に基づく瞬時周波数推定値は

$$\hat{f}_k = \frac{1}{\Delta_k}$$

となります。検証のため、真の瞬時周波数 $f(t)$ を周期中点 $\hat{\tau}_k + \Delta_k/2$ でサンプリングし、$\hat{f}_k$ と比較します。

## 可視化

デモスクリプトは以下の 2 つのプロットを生成します。

1. 推定した周期開始時刻に垂直線を描いた観測信号の波形。DTW がテンプレートをどのように伸縮させたかが視覚的にわかります。
2. 真の瞬時周波数 $f(t)$ と DTW 推定 $\hat{f}_k$ を重ねた時間-周波数グラフ。推定誤差を直感的に確認できます。

`python interval_detection.py` を実行すると、表形式の推定結果が表示され、同時に Matplotlib の図が開いて詳細を確認できます。
