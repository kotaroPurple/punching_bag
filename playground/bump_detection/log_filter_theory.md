# MultiLobeComb で周期成分が弱まり bump が残る理由

## 1. 出力は畳み込みで決まる

入力信号を $x(t)$、カーネルを $h(t)$ とすると、出力は

$y(t) = (h * x)(t)$

です。周波数領域では

$Y(\omega) = H(\omega) X(\omega)$

となるため、フィルタの本質は $H(\omega)$（周波数応答）で決まります。

---

## 2. 正弦波が弱まる条件

正弦波 $x(t)=\sin(\omega_0 t)$ は LTI 系の固有関数なので、出力振幅は

$|H(\omega_0)|$

倍になります。したがって、うなりを作る周波数帯で $|H(\omega)|$ が小さければ、その繰り返し成分は弱まります。

---

## 3. MultiLobeComb の形と周波数応答

MultiLobeComb は「中心ローブ + 左右に周期間隔で並ぶ交互符号ローブ」で、概念的に

$h(t) = g_0(t) + \sum_{k=1}^{K} a_k \left[g(t-kT)+g(t+kT)\right]$

と書けます。ここで

- $T$ はローブ間隔（打ち消したい周期に対応）
- $a_k$ は交互符号（例: $-,+,-,+,\dots$）かつ減衰付き
- $g_0, g$ はガウス形ローブ

とします。

偶対称性により周波数応答は

$H(\omega) = G(\omega)\left[c_0 + 2\sum_{k=1}^{K} a_k \cos(\omega kT)\right]$

の形になります（$G(\omega)$ はローブ包絡のスペクトル）。

中括弧

$B(\omega)=c_0 + 2\sum_{k=1}^{K} a_k \cos(\omega kT)$

が 0 に近い周波数ではノッチができ、周期成分が強く抑圧されます。  
つまり、$T \approx 1/f_{\text{beat}}$ 付近に合わせると、beat 由来の繰り返しが消えやすくなります。

---

## 4. bump が残る理由

bump は時間局在した信号（例: ガウシアン突起）なので、周波数的には広帯域です。  
そのため、特定周波数だけにノッチを作っても全成分は消えません。

$X_{\text{bump}}(\omega)$ は広く分布し、$Y_{\text{bump}}(\omega)=H(\omega)X_{\text{bump}}(\omega)$ でもノッチ外の成分が残る

ので、時間波形として bump が観測されます。

また、カーネルをゼロ平均（$\int h(t)\,dt \approx 0$）に正規化すると、低周波・基線成分は抑えられ、局所変化（bump 周辺）が相対的に強調されます。

---

## 5. ローブ数を増やす効果とトレードオフ

ローブ数 $K$ を増やすと

- ノッチを深く/鋭くしやすい（周期抑圧が強化）
- 一方で時間幅が長くなり、局所イベントにも影響しやすい

というトレードオフがあります。  
実験で `MultiLobeComb(3)` と `MultiLobeComb(5)` の差が出るのはこのためです。

---

## 6. 実装上の設計指針

1. ローブ間隔 $T$ を打ち消したい周期に合わせる（例: $T \approx 1/5.4$ 秒）
2. $K$（ローブ数）を増やしすぎない
3. 側ローブ減衰係数（`decay`）で過剰なリンギングを抑える
4. ゼロ平均・単位ノルム正規化で比較を公平化する

この設計により、`周期的な sin/beat` を抑えつつ `局所 bump` を残す動作を作れます。

---

## 7. MultiLobeComb の作り方（実装レシピ）

`multicycle_dog_comb_kernel` の作り方は次の通りです。

### Step 1: パラメータを決める

- サンプリング周波数 $f_s$
- 打ち消したい中心周波数 $f_c$（または周期 $T=1/f_c$）
- 側ローブ数 $K$（`n_side`）
- 側ローブ幅 $\sigma_{\text{side}}$（`side_sigma_s`）
- 側ローブ減衰率 $\rho$（`decay`）

離散サンプルへ変換すると

$T_n = T f_s,\quad \sigma_n = \sigma_{\text{side}} f_s$

です。

### Step 2: 中央ローブを置く

中央ピークを持つガウシアンを作ります（実装では少し狭める）:

$h_0[n] = \exp\left(-\frac{n^2}{2(0.75\sigma_n)^2}\right)$

### Step 3: 左右に交互符号ローブを置く

$k=1,\dots,K$ に対して、中心 $\pm kT_n$ のローブを追加します。

$h_k[n] = a_k\left(
\exp\left(-\frac{(n-kT_n)^2}{2\sigma_n^2}\right)+
\exp\left(-\frac{(n+kT_n)^2}{2\sigma_n^2}\right)
\right)$

係数は

$a_k = (-1)^k \rho^{k-1}$

として、符号を交互にしつつ外側ほど弱めます。

最終的に

$h[n] = h_0[n] + \sum_{k=1}^{K} h_k[n]$

です。

### Step 4: 正規化する

比較可能性と安定性のために

1. ゼロ平均化: $h \leftarrow h - \overline{h}$
2. 単位ノルム化: $h \leftarrow h / \|h\|_2$

を行います。これで DC 成分が抑制され、スケール依存の振幅差も減らせます。

### Step 5: チューニングの勘所

- $T$:
  ノッチ位置を決める最重要パラメータ。beat 周波数に合わせる。
- $K$:
  増やすとノッチが深くなりやすいが、時間幅が伸びて bump も削りやすい。
- $\sigma_{\text{side}}$:
  小さいと鋭いノッチ、大きいと広帯域に抑圧。
- $\rho$:
  大きいと外側ローブが効いて周期抑圧が強いが、リンギングが増える場合がある。
